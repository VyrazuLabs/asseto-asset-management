{% load custom_filters %}
{% load static %}
{% if page_object %}
    <thead>
        <tr>
            <th>Sl No.</th>
            <th>Image</th>
            <th>Asset Tag</th>
            <th>Asset Name</th>
            <th>Product Type</th>
            <th>Product</th>
            <th>Vendor</th>
            <th>Current State</th>
            <th>Status</th>
            {% if perms.authentication.edit_asset or perms.authentication.view_asset or perms.authentication.delete_asset %}
                <th>Actions</th>
            {% endif %}
        </tr>
    </thead>
    <tbody id="search_result">
        {% for asset in page_object %}
        <tr>
            <td>{{forloop.counter}}</td>
            <td>
                {% with img=asset_images|get_item:asset.id %}
                    {% if img %}
                        <img src="{{ img.image.url }}" alt="{{ asset.name }}" style="max-width:100px; max-height:100px;">
                    {% elif not img.image.url %}
                        <img src="{% static 'assets/images/No_Image.jpg' %}" style="max-width:100px; max-height:100px;">
                    {% endif %}
                {% endwith %}
            </td>
            <td>{{asset.tag}}</td>
            <td>{{asset.name}}</td>
            <td>{{asset.product.product_type}}</td>
            
            <td>
                {{asset.product}}
                {% if asset.product.is_deleted %}
                <i class="bi bi-exclamation-triangle text-warning" title="Product is deleted, please update or restore."></i>
                {% endif %}
            </td>
            <td>
                {{asset.vendor}} 
                {% if asset.vendor.is_deleted %}
                <i class="bi bi-exclamation-triangle text-warning" title="Vendor is deleted, please update or restore."></i>
                {% endif %}
            </td>
            <td>
                {% if asset.is_assigned %}
                    <sup class="d-flex align-items-center">{% with map=asset_user_map|get_item:asset.id %}{% if map.image %}<img src='{{ map.image.url }}' class="rounded-circle" style="width: 20px; height: 20px "/> {% endif %} {{ map.full_name }}{% endwith %}</sup>
                    <form action="{% url 'assets:delete_assign_asset_list' asset.id %}" method="post" onsubmit="return confirm('Are you sure you want to unassign this?')">  
                            {% csrf_token %}
                            <button type="submit" value="Delete" class="btn btn-sm btn-danger">Unassign</button>
                    </form>
                {% else %}
                    <div class="input-group">
                        <button type="button"  
                            class="btn btn-info btn-sm"
                            hx-get="{% url 'assets:assign_asset_in_asset_list' asset.id %}"
                            hx-target="#assign-asset-modal-list-content"
                            data-bs-toggle="modal"
                            data-bs-target="#assign-asset-list-modal">
                            Assign
                        </button>
                    </div>
                {% endif %}
            </td>
            {{active_users}}
            <td>
                <div class="d-flex justify-content-between gap-2">
                    {% if not asset.is_assigned %}
                        <select class="status-select form-select" data-asset-id="{{ asset.id }}" id="status-id-{{ asset.id }}">
                            <option id="selected-val" disabled selected>{{ asset.asset_status.name }}</option>
                            {% for value, label in asset_form.fields.status.choices %}
                                <option value="{{ value }}" {% if asset.status|stringformat:'s' == value|stringformat:'s' %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    {% elif asset.is_assigned %}
                        <select class="status-select form-select" data-asset-id="{{ asset.id }}" id="status-id-{{ asset.id }}" disabled>
                            <option value="Assigned" {% if asset.status|stringformat:'s' == value|stringformat:'s' %}selected{% endif %}>Assigned</option>
                        </select>
                    {% endif %}
                </div>
            <div style="display: none;" class="release-button-container" id="release-btn-container-{{ asset.id }}">
                <div class="input-group">
                    <button type="button" class="btn btn-warning release-asset-btn"
                            data-asset-id="{{ asset.id }}">
                        Release
                    </button>
                </div>
            </div>

                <!-- {% if asset.asset_status.name == "Ready To Deploy" %}
                    <form method="post" action="{% url 'assets:release' asset.id %}">
                    {% csrf_token %}
                        <button 
                        type="button" 
                        class="btn btn-warning btn-sm release-asset-btn" 
                        data-asset-id="{{ asset.id }}"
                        data-csrf-token="{{ csrf_token }}">
                        Release
                    </button>
                    </form>
                {% elif asset.asset_status.name == "Available" %}
                    <form 
                        method="post" 
                        action="{% url 'assets:change_status' asset.id %}" 
                        class="assign-user-form" 
                        data-asset-id="{{ asset.id }}"
                    >
                        {% csrf_token %}
                        <div class="input-group">
                            <select name="user_id" class="form-select" required>
                                <option value="">Select User</option>
                                {% for user in active_user %}
                                    <option value="{{ user.id }}">{{ user.full_name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary btn-sm">Assign</button>
                        </div>
                    </form>
                {% endif %} -->
            </td>
            
            <td>
                <div class="btn-group btn-group-sm" role="group" aria-label="Basic example">
                    {% if perms.authentication.view_asset %}
                        <a href="{% url 'assets:details' asset.id %}" class="btn btn-success"><i class="bi bi-eye-fill"></i></a>
                    {% endif %}
                    {% if perms.authentication.edit_asset %}
                        <a href="{% url 'assets:update_in_detail' asset.id %}"type="button" class="btn btn-info"><i class="bi bi-pencil-square"></i></a>
                    {% endif %}
                    {% if perms.authentication.delete_asset %}
                        <form action="{% url 'assets:delete' asset.id %}" method="post" onsubmit="return confirm('Are you sure you want to delete this?')">  
                            {% csrf_token %}
                            <button type="submit" value="Delete" class="btn btn-sm btn-danger"><i class="bi bi-trash3-fill"></i></button>
                        </form>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
{% endif %}
