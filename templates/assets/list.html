{% extends 'layouts/main-layout.html' %}
{% load custom_filters %}
{% load static %}
{% block content %}
<div class="page-heading">
    {% csrf_token %}
    <div class="d-flex justify-content-between">
        <div class="page-title">
            <h3>Assets</h3>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Assets</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex">
            {% if perms.authentication.add_asset %}
                <div>
                    <a href="{% url 'assets:add' %}" class="btn btn-sm btn-outline-info my-3 me-2">Add Asset</a>
                </div>
            {% endif %}
                <a href="{% url 'recycle_bin:deleted_assets' %}" class="btn btn-sm btn-outline-info my-3 trash-btn d-flex align-items-center position-relative">
                <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-trash" style="margin-bottom: 2px;"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                </svg>Trash</a>
        </div>
    </div>
    <section class="section">
        <div class="card">
            <div class="card-body">
                <div class="filter">
                    <div class="d-flex justify-content-between gap-2">
                        <form id="asset-filter-form"
                            hx-get="{% url 'assets:search' page_object.number %}"
                            hx-target="#search_result"
                            hx-trigger="change, keyup changed delay:500ms from:input">

                            <div class="d-flex justify-content-start gap-2">
                            <!-- Search -->
                                <div>
                                <input name="search_text"
                                        type="search"
                                        class="dataTable-input"
                                        autocomplete="off"
                                        placeholder="Search here...">
                                </div>

                                <!-- Status -->
                                <div class="dropdown-asset-status">
                                <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    Select Status
                                </button>
                                <ul class="dropdown-menu">
                                    {% for status in asset_status_list %}
                                    <li>
                                    <a href="#"
                                        class="dropdown-item"
                                        onclick="event.preventDefault(); 
                                                this.closest('form').querySelector('[name=status]').value='{{ status.id }}'; 
                                                this.closest('.dropdown-asset-status').querySelector('button').innerText='{{ status.name }}';
                                                htmx.trigger(this.closest('form'),'change');">
                                        {{ status.name }}
                                    </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                                <input type="hidden" name="status">
                                </div>

                                <!-- Vendor -->
                                <div class="dropdown-asset-vendors">
                                <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    Select Vendor
                                </button>
                                <ul class="dropdown-menu">
                                    {% for vendor in vendor_list %}
                                    <li>
                                    <a href="#"
                                        class="dropdown-item"
                                        onclick="event.preventDefault(); 
                                                this.closest('form').querySelector('[name=vendor]').value='{{ vendor.id }}'; 
                                                this.closest('.dropdown-asset-vendors').querySelector('button').innerText='{{ vendor.name }}';
                                                htmx.trigger(this.closest('form'),'change');">
                                        {{ vendor.name }}
                                    </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                                <input type="hidden" name="vendor">
                                </div>

                                <!-- Product Type -->
                                

                                <div class="dropdown-asset-product-type">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        Select Product Type
                                    </button>
                                    <ul class="dropdown-menu">
                                        {% for type in product_type_list %}
                                        <li>
                                            <a href="#"
                                                class="dropdown-item"
                                                onclick="event.preventDefault(); 
                                                        this.closest('form').querySelector('[name=type]').value='{{ type.id }}';
                                                        this.closest('.dropdown-asset-product-type').querySelector('button').innerText='{{ type.name }}';
                                                        htmx.trigger(this.closest('form'),'change');">
                                                {{ type.name }}
                                            </a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    <input type="hidden" name="type">
                                </div>

                                <!--User-->
                                <div class="dropdown-asset-users">
                                <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    Select User
                                </button>
                                <ul class="dropdown-menu">
                                    {% for user in user_list %}
                                    <li>
                                    <a href="#"
                                        class="dropdown-item"
                                        onclick="event.preventDefault(); 
                                                this.closest('form').querySelector('[name=user]').value='{{ user.id }}'; 
                                                this.closest('.dropdown-asset-users').querySelector('button').innerText='{{ user.full_name }}';
                                                htmx.trigger(this.closest('form'),'change');">
                                        {{ user.full_name }}
                                    </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                                <input type="hidden" name="user">
                                </div>
                            </div>
                        </form>
                        <div class="d-flex justify-content-end">
                            <a href="{% url 'assets:list' %}" class="btn btn-info">Reset</a>
                        </div>
                    </div>
                </div>
                </br>
                <table class="table" id="table1">
                    <thead>
                        <tr>
                            <th>Sl No.</th>
                            <th>Image</th>
                            <th>Asset Name</th>
                            <th>Serial No.</th>
                            <th>Product Type</th>
                            <th>Product</th>
                            <th>Vendor</th>
                            <th>Current State</th>
                            <th>Status</th>
                            {% if perms.authentication.edit_asset or perms.authentication.view_asset or perms.authentication.delete_asset %}
                                <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    {% if page_object %}
                    <tbody id="search_result">
                          {% for asset in page_object %}
                        <tr>
                            <td>{{page_object.start_index|add:forloop.counter0}}</td>
                            <td>
                                {% with img=asset_images|get_item:asset.id %}
                                    {% if img %}
                                        <img src="{{ img.image.url }}" alt="{{ asset.name }}" style="max-width:100px; max-height:100px;">
                                    {% elif not img.image.url %}
                                        <img src="{% static 'assets/images/No_Image.jpg' %}" style="max-width:100px; max-height:100px;">
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>{{asset.name}}</td>
                            <td>{{asset.serial_no}}</td>
                            <td>{{asset.product.product_type}}</td>
                            
                            <td>
                                {{asset.product}}
                                {% if asset.product.is_deleted %}
                                <i class="bi bi-exclamation-triangle text-warning" title="Product is deleted, please update or restore."></i>
                                {% endif %}
                            </td>
                            <td>
                                {{asset.vendor}} 
                                {% if asset.vendor.is_deleted %}
                                <i class="bi bi-exclamation-triangle text-warning" title="Vendor is deleted, please update or restore."></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if asset.is_assigned %}
                                    <form action="{% url 'assets:delete_assign_asset_list' asset.id %}" method="post" onsubmit="return confirm('Are you sure you want to unassign this?')">  
                                            {% csrf_token %}
                                            <button type="submit" value="Delete" class="btn btn-sm btn-danger">Unassign</button>
                                    </form>
                                {% else %}
                                    <div class="input-group">
                                        <button type="button"  
                                            class="btn btn-info btn-sm"
                                            hx-get="{% url 'assets:assign_asset_in_asset_list' asset.id %}"
                                            hx-target="#assign-asset-modal-list-content"
                                            data-bs-toggle="modal"
                                            data-bs-target="#assign-asset-list-modal">
                                            Assign
                                        </button>
                                    </div>
                                {% endif %}
                            </td>
                            {{active_users}}
                            <td>
                                <div class="d-flex justify-content-between gap-2">
                                    {% if not asset.is_assigned %}
                                        <select class="status-select form-select" data-asset-id="{{ asset.id }}" id="status-id-{{ asset.id }}">
                                            <option id="selected-val" disabled selected>{{ asset.asset_status.name }}</option>
                                            {% for value, label in asset_form.fields.status.choices %}
                                                <option value="{{ value }}" {% if asset.status|stringformat:'s' == value|stringformat:'s' %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    {% elif asset.is_assigned %}
                                        <select class="status-select form-select" data-asset-id="{{ asset.id }}" id="status-id-{{ asset.id }}" disabled>
                                            <option value="Assigned" {% if asset.status|stringformat:'s' == value|stringformat:'s' %}selected{% endif %}>Assigned</option>
                                        </select>
                                    {% endif %}
                                </div>
                            <div style="display: none;" class="release-button-container" id="release-btn-container-{{ asset.id }}">
                                <div class="input-group">
                                    <button type="button" class="btn btn-warning release-asset-btn"
                                            data-asset-id="{{ asset.id }}">
                                        Release
                                    </button>
                                </div>
                            </div>

                                <!-- {% if asset.asset_status.name == "Ready To Deploy" %}
                                    <form method="post" action="{% url 'assets:release' asset.id %}">
                                    {% csrf_token %}
                                     <button 
                                        type="button" 
                                        class="btn btn-warning btn-sm release-asset-btn" 
                                        data-asset-id="{{ asset.id }}"
                                        data-csrf-token="{{ csrf_token }}">
                                        Release
                                    </button>
                                    </form>
                                {% elif asset.asset_status.name == "Available" %}
                                    <form 
                                        method="post" 
                                        action="{% url 'assets:change_status' asset.id %}" 
                                        class="assign-user-form" 
                                        data-asset-id="{{ asset.id }}"
                                    >
                                        {% csrf_token %}
                                        <div class="input-group">
                                            <select name="user_id" class="form-select" required>
                                                <option value="">Select User</option>
                                                {% for user in active_user %}
                                                    <option value="{{ user.id }}">{{ user.full_name }}</option>
                                                {% endfor %}
                                            </select>
                                            <button type="submit" class="btn btn-primary btn-sm">Assign</button>
                                        </div>
                                    </form>
                                {% endif %} -->
                            </td>
                            
                            <td>
                                <div class="btn-group btn-group-sm" role="group" aria-label="Basic example">
                                    {% if perms.authentication.view_asset %}
                                        <a href="{% url 'assets:details' asset.id %}" class="btn btn-success"><i class="bi bi-eye-fill"></i></a>
                                    {% endif %}
                                    {% if perms.authentication.edit_asset %}
                                        <a href="{% url 'assets:update_in_detail' asset.id %}"type="button" class="btn btn-info"><i class="bi bi-pencil-square"></i></a>
                                    {% endif %}
                                    {% if perms.authentication.delete_asset %}
                                        <form action="{% url 'assets:delete' asset.id %}" method="post" onsubmit="return confirm('Are you sure you want to delete this?')">  
                                            {% csrf_token %}
                                            <button type="submit" value="Delete" class="btn btn-sm btn-danger"><i class="bi bi-trash3-fill"></i></button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% else %}
                      <div class="alert alert-info" role="alert">
                        No record available!
                      </div>
                    {% endif %}
                </table>
                {% include 'commons/pagination.html' %}
                </div>
                <div class="modal fade" id="assign-asset-list-modal" tabindex="-1" aria-labelledby="assignAssetLabel">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content" id="assign-asset-modal-list-content" hx-target="this"><!-- HTMX will inject modal content here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
<script>


document.querySelectorAll('.status-select').forEach(function(select) {
    select.addEventListener('change', function() {
        const get_selected_val = document.getElementById('selected-val').value;
        const assetIdRaw = this.getAttribute('data-asset-id');
        const assetId = assetIdRaw ? assetIdRaw.replace(/-/g, "") : null;
        const statusValue = this.value;
        const currentSelect = this; // for UI updates later
        if (!assetId) {
            console.error("Asset ID missing");
            return;
        }

        fetch(`/assets/change-status/${assetId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({status: statusValue})
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to update status');
            return response.json();
        })
        .then(data => {
            console.log('Status updated', data);
            updateStatusUI(assetId, statusValue, currentSelect);  // Update UI dynamically
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message);
        });
    });
});


function updateStatusUI(assetId, statusValue, selectElement) {
    // Example: Show a small success message next to select
    let msgElem = selectElement.parentElement.querySelector('.status-msg');
    if (!msgElem) {
        msgElem = document.createElement('span');
        msgElem.className = 'status-msg ms-2';  // spacing margin
        selectElement.parentElement.appendChild(msgElem);
    }
    // msgElem.textContent = 'Status updated!';
    // msgElem.style.color = 'green';

    // Remove the message after 2 seconds
    setTimeout(() => {
        if (msgElem.parentElement) {
            msgElem.parentElement.removeChild(msgElem);
        }
    }, 2000);

    // Optionally: update other parts of UI, styles, buttons, etc. based on statusValue
}

// Helper function to get CSRF token cookie (Django default)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
            const trimmed = cookie.trim();
            if (trimmed.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", function () {
    // Function to get CSRF token from cookies
    function getCSRFToken() {
        let cookieValue = null;
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith("csrftoken=")) {
                cookieValue = cookie.substring("csrftoken=".length, cookie.length);
                break;
            }
        }
        return cookieValue;
    }

    // Attach click listener to all assign buttons
    document.querySelectorAll(".assign-btn").forEach(function(button) {
        button.addEventListener("click", function() {
            const assetId = this.getAttribute("data-asset-id");
            const statusField = document.getElementById("status-id-" + assetId);
            const container = document.getElementById("assign-btn-container-" + assetId);
            const userSelect = container.querySelector("select[name='user_id']");
            const userId = userSelect.value;
            console.log(userId)

            if (!userId) {
                alert("Please select a user first!");
                return;
            }
            fetch(`/assets/status-ready-to-assign/${assetId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": getCSRFToken(),
                },
                body: new URLSearchParams({ user_id: userId })
            })
            .then(response => {
                if (!response.ok) throw new Error("Network error");
                return response.text();
            })
            .then(data => {
                alert("Asset successfully assigned!");
                // e.g. hide the assign form & change status text
                container.style.display = "none";
                const statusDropdown = document.querySelector(`.status-select[data-asset-id="${assetId}"]`);
                if (statusDropdown) {
                    statusDropdown.value = "Assigned";  // update dropdown
                }
                statusField.disabled = true;  // disable further changes
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Failed to assign asset. Please try again.");
            });
        });
    });

    document.querySelectorAll(".release-asset-btn").forEach(function(button) {
        button.addEventListener("click", function() {
            const statusField = document.getElementById("status-id-" + assetId);
            const assetId = this.getAttribute("data-asset-id");
            const container = document.getElementById("release-btn-container-" + assetId);
            // const userSelect = container.querySelector("select[name='user_id']");
            // const userId = userSelect.value;

            fetch(`/assets/status-repair-to-release/${assetId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": getCSRFToken(),
                }
            })
            .then(response => {
                if (!response.ok) throw new Error("Network error");
                return response.text();
            })
            .then(data => {
                // ðŸ”¥ Optional: Update UI without reload
                // e.g. hide the assign form & change status text
                container.style.display = "none";
                const statusDropdown = document.querySelector(`.status-select[data-asset-id="${assetId}"]`);
                if (statusDropdown) {
                    statusDropdown.value = "Available";  // update dropdown
                }
                statusField.disabled = false;  // enable further changes
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Failed to assign asset. Please try again.");
            });
        });
    });
});
</script>

</script>
    
{% endblock content%}
<script type="application/json" id="active-users-json">
    {{ active_user|json_script:"active-users-json" }}
</script>
<script>
document.querySelectorAll(".status-select").forEach(function(select) {
    select.addEventListener("change", function() {
        if (this.value === "Assigned" || this.value === "In Use") {
            this.disabled = true;
            this.closest("tr").querySelector(".assign-button-container")?.remove();
        }
    });
});
</script>

