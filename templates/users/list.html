{% extends 'layouts/main-layout.html' %}
{% block content %}
{% load custom_filters %}

{% load static %}
<table class="table table-hover" id="table1">
    <thead>
        <tr>
            <th>Sl No.</th>
            <th>Image</th>
            <th>Name</th>
            <th>Email</th>
            <th>Assigned Assets</th>
            <th>Designation</th>
            <th>Access Level</th>
            <th>Last Login</th>
            {% if request.user.is_superuser %}
                <th>Status</th>
            {% endif %}
            {% if perms.authentication.delete_users or perms.authentication.view_users or perms.authentication.edit_users %}
                <th>Actions</th>
            {% endif %}
        </tr>
    </thead>
    {% if page_object %}
        <tbody id="search_result">
            {% for user in page_object %}
                <tr>
                    <td>{{page_object.start_index|add:forloop.counter0}}</td>
                    <td>
                        <div class="user-img d-flex align-items-center">
                            <div class="avatar avatar-lg">
                                {% if user.profile_pic %}
                                    <img src="{{ user.profile_pic.url }}"
                                        alt="{{ user.get_full_name|default:user.username }}"
                                        onerror="this.onerror=null; this.src='{% static 'assets/images/faces/1.jpg' %}';">
                                {% else %}
                                    <img src="{% static 'assets/images/faces/1.jpg' %}"
                                        alt="Default user">
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td>{{user.full_name | title}}</td>
                    <td>{{user.email}}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px">
                                    {% if user.id in user_asset_map_count %}
                                        <form method="get" action="{% url 'assets:search_assets' page_object.number %}">
                                            <input type="hidden" name="user-data" value="{{ user.id }}">
                                            <button type="submit" 
                                                    class="btn btn-sm text-white"
                                                    style="background-color: rgb(67, 94, 204); border: none; border-radius: 7px; cursor: pointer; padding-right: 7px;">
                                                {{ user_asset_map_count_count|get_item:user.id }}
                                            </button>
                                        </form>
                                    {% else %}
                                        <p>0</p>
                                    {% endif %}
                        </div>
                    </td>
                    <td>{{user.role}}</td>
                    <td>{% if user.access_level %}All{% else %}Only Assigned{% endif %}</td>
                    <td>{{user.last_login}}</td>
                    {% if request.user.is_superuser %}
                        <td>
                            <div class="form-check form-switch">
                                <input 
                                    class="form-check-input"
                                    hx-post="{% url 'users:status' user.id %}" 
                                    hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}'
                                    type="checkbox" {% if user.is_active %} checked {% endif %}
                                    style="cursor: pointer;"
                                >
                            </div>
                        </td>
                    {% endif %}
                    {% if perms.authentication.delete_users or perms.authentication.view_users or perms.authentication.edit_users %}
                        <td>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Basic example">
                                {% if perms.authentication.view_users %}
                                    <a href="{% url 'users:details' user.id %}" class="btn btn-success"><i class="bi bi-eye-fill"></i></a>
                                {% endif %}
                                {% if perms.authentication.edit_users %}
                                    <button type="button" class="btn btn-info" 
                                        hx-get="{% url 'users:update' user.id %}" hx-target="#update-user-modal-content"
                                        data-bs-toggle="modal" data-bs-target="#update-user-modal"
                                    ><i class="bi bi-pencil-square"></i></button>
                                {% endif %}
                                {% if perms.authentication.delete_users %}
                                    <form action="{% url 'users:delete' user.id %}" method="post" onsubmit="return confirm('Are you sure you want to delete this?')">  
                                        {% csrf_token %}
                                        <button type="submit" value="Delete" class="btn btn-sm btn-danger"><i class="bi bi-trash3-fill"></i></button>
                                    </form>
                                {% endif %}
                            </div>
                        </td>
                    {% endif %}
                </tr>
            {% endfor %}
        </tbody>
    {% else %}
        <div class="alert alert-info" role="alert">
            No record available!
        </div>
    {% endif %}
</table>
{% include 'commons/pagination.html' %}
{% endblock content %}