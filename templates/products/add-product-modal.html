<div class="modal-content">
    <div class="modal-header bg-dark">
        <h5 class="modal-title white w-100 text-center" id="myModalLabel160">
            Add Product
        </h5>
        <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
        ></button>
    </div>
    <form
        hx-encoding="multipart/form-data"
        hx-post="{{request.path}}"
        novalidate
    >
        {% csrf_token %}
        <div class="modal-body">

            <div class="form-group">
                <label>Product Name</label>
                {{form.name}} 
                {% for error in form.name.errors %}
                    <small class="text-danger mb-3">{{ error }}</small>
                {% endfor %}
            </div>

            <div class="form-group">
                <label>Product Type</label>
                {{form.product_type}} 
                {% for error in form.product_type.errors %}
                    <small class="text-danger mb-3">{{ error }}</small>
                {% endfor %}
            </div>

            <!-- Product Category -->
            <div class="form-group mb-2">
                <label>Product Category</label>
                {{ form.product_category }}
                {% for error in form.product_category.errors %}
                <small class="text-danger mb-3">{{ error }}</small>
                {% endfor %}
            </div>

            <!-- Product Sub Category -->
            <div class="form-group mb-2">
                <label>Product Sub Category</label>
                {{ form.product_sub_category }}
                {% for error in form.product_sub_category.errors %}
                <small class="text-danger mb-3">{{ error }}</small>
                {% endfor %}
            </div>

            <div class="form-group">
                <label>Manufacturer</label>
                {{form.manufacturer}}
                {% for error in form.manufacturer.errors %}
                    <small class="text-danger mb-3">{{ error }}</small>
                {% endfor %}
            </div>

            <!-- Model -->
            <div class="form-group mb-2">
                <label>Model</label>
                {{ form.model }}
                {% for error in form.model.errors %}
                <small class="text-danger mb-3">{{ error }}</small>
                {% endfor %}
            </div>

            <!-- Product EOL -->
            <div class="form-group mb-2">
                <label>Product EOL</label>
                {{ form.eol }}
                {% for error in form.eol.errors %}
                <small class="text-danger mb-3">{{ error }}</small>
                {% endfor %}
            </div>

            <div class="form-group">
                <label>Description</label>
                {{form.description}}
                {% for error in form.description.errors %}
                    <small class="text-danger mb-3">{{ error }}</small>
                {% endfor %}
            </div>
            <div class="col-md-6 col-12">
                <div class="form-group">
                    <label for="company-column">Add Product Image</label>
                    {{image_form.image}}
                    {% for error in image_form.image.errors %}
                    <small class="text-danger mb-3">{{ error }}</small>
                    {% endfor %}
                </div>
                <div class="form-group rounded ml-2" id="imagePreview"></div>                    
            </div>
        </div>

        <div class="modal-footer">
            <button
                type="button"
                class="btn btn-sm btn-light-secondary"
                data-bs-dismiss="modal"
            >
                <i class="bx bx-x d-block d-sm-none"></i>
                <span class="d-none d-sm-block">Close</span>
            </button>

            <button type="submit" class="btn btn-sm btn-info ml-1"
                onclick="this.innerHTML = `<span class='spinner-grow spinner-grow-sm' role='status' aria-hidden='true'></span> Saving...`;"
            >
                <i class="bx bx-check d-block d-sm-none"></i>
                <span class="d-none d-sm-block">Save</span>
            </button>
        </div>
    </form>
    <script>
        // Image Preview
        function filePreview(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $("#imagePreview + img").remove();
                    $("#imagePreview").after(
                        '<img src="' +
                            e.target.result +
                            '" class="rounded" width="100" height="80"/>'
                    );
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        $("#inputFile").change(function () {
            $("#imagePreview img").remove();
            filePreview(this);
        });

        // HTMX hook to reload page on successful form submission
        htmx.on("htmx:beforeSwap", (e) => {
            if (
                e.detail.target.id == "add-product-modal-content" &&
                !e.detail.xhr.response
            ) {
                location.reload();
            }
        });

        // HTMX trigger on category change to fetch subcategories
        document.querySelector('#id_product_category')?.addEventListener('change', function () {
            const categoryId = this.value;
            const subCatSelect = document.querySelector('#id_product_sub_category');

            // Reset the subcategory dropdown
            subCatSelect.innerHTML = '<option value="">Loading...</option>';

            fetch(`/admin/get-subcategories/?category_id=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    let options = '<option value="">--SELECT--</option>';
                    data.forEach(function (item) {
                        options += `<option value="${item.id}">${item.name}</option>`;
                    });
                    subCatSelect.innerHTML = options;
                })
                .catch(() => {
                    subCatSelect.innerHTML = '<option value="">Error loading</option>';
                });
        });
    </script>

</div>
